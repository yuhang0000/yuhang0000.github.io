name: è‡ªå‹•æ›´æ–°æäº¤æ—¥æœŸ

# è§¸ç™¼æ¢ä»¶: ç­‰ pages build and deployment æå®Œã€‚
on:
  workflow_run:
    workflows: ["pages-build-deployment"]
    types:
      - completed
      
# è§¸ç™¼æ¢ä»¶: ç•¶æœ‰æ¨é€ï¼ˆpushï¼‰äº‹ä»¶åˆ° main åˆ†æ”¯æ™‚è§¸ç™¼æ­¤å·¥ä½œæµã€‚

# on:
#   push:
#     branches:
#       - main

# ä»»å‹™: 
jobs:
  update-file:
    runs-on: ubuntu-latest
    # æ‰“é»æ³¨é‡‹ï¼Œå¦‚æœéƒ¨ç½²ç™¼èµ·è€…æ˜¯ github-pages çš„è©±ç›´æ¥ä¸å¹¹äº†ã€‚
    if: ${{ github.actor != 'github-pages' }}
    
    permissions:
      contents: write

    # ä½¿ç”¨ GitHub API æ›´æ–°æ–‡ä»¶å†…å®¹ã€‚
    steps:
    - name: å‰µå»ºæ–‡ä»¶å¤¾
      run: mkdir -p ./Config/
    
    - name: æ›´æ–° Config/UpdateTime.txt æ–‡æª”
      uses: actions/github-script@v6
      with:
        script: |
          //å®Œå…¨ä¸æœƒå­¸é€™å€‹, äº¤çµ¦é€šç¾©å¯«å­ã€‚
        
          // å¼•ç”¨å¤–éƒ¨åº«
          let fs = require('fs');
          // let github = require('@actions/github');
          // let context = require('@actions/github');
          // let { context, github } = require('@actions/github');

          //ç²å–ç•¶å‰æ™‚é–“
          function gettime(){
            let now = new Date();
            
            //æ™‚å€ +08:00
            now = now.valueOf() + (3600 * 1000 * 8);
            now = new Date(now);
            
            let nowtime = now.getFullYear() + "-" + (now.getMonth() + 1) + "-" + now.getDate() + " " + now.getHours() + ":" + String(now.getMinutes()).padStart(2, '0') + ":" + String(now.getSeconds()).padStart(2, '0');
            return nowtime;
          }
          
          console.log("# " + gettime() + " | æº–å‚™å˜—è©¦ã€‚ã€‚ã€‚");
          let content = Buffer.from(gettime()).toString('base64');

          //å˜—è©¦å…ˆæ›´æ–°
          try{

            //é€™è£ç²å–sha, å®Œå…¨ä¸æœƒå‘€ğŸ˜­, é‚„å¾—æ„Ÿè¬é€šç¾©ã€‚
            let response = await github.rest.repos.getContent({
              ...context.repo,
              path: "Config/UpdateTime.txt"
            });

            let sha = response.data.sha;
            
            await github.rest.repos.createOrUpdateFileContents({
              ...context.repo,
              path: "Config/UpdateTime.txt",
              message: "æ›´æ–°æœ€å¾Œä¸€æ¬¡æäº¤æ—¥æœŸ",
              content: content,
              sha: sha,
              branch: context.ref.replace('refs/heads/', '')
            });
          }
          catch(err){
            console.log("# " + gettime() + " | é‡åˆ°é”™è¯¯äº†æ¬¸, å˜—è©¦ç›´æ¥å‰µå»ºæ–°æ–‡æª”: \r\n" + err.stack);
            trywrite();
          }

          async function trywrite(){
            try {
              // å¯«å…¥æ–‡æª”
              //fs.writeFileSync("${process.env.GITHUB_WORKSPACE}/config", nowtime);

                await github.rest.repos.createOrUpdateFileContents({
                  ...context.repo,
                  path: "Config/UpdateTime.txt",
                  message: "æ›´æ–°æœ€å¾Œä¸€æ¬¡æäº¤æ—¥æœŸ",
                  content: content,
                  branch: context.ref.replace('refs/heads/', '')
                });
            }
            catch(err){
              console.log("# " + gettime() + " | é‡åˆ°é”™è¯¯äº†æ¬¸: \r\n" + err.stack);
            }
          }
          
          console.log("# " + gettime() + " | å®Œæˆå’¯! ");       
